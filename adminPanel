#!/usr/bin/bash

filename="/scripts/$(date "+%d-%m-%Y")-report.txt"
echo file saved at "$filename"

exec > >(tee "$filename")
echo ========== REPORT GENERATED ==========
echo generated on $(date "+%H:%M:%S %d-%m-%Y")
echo generated by $USER

cat_published=(0 0 0 0 0 0 0)
cat_deleted=(0 0 0 0 0 0 0)
total_published=0
total_deleted=0

readarray all_blogs <<< $(yq ".blogs[].file_name" /scripts/article.yaml)
total_count=${#all_blogs[@]}
highest=-1
first=""
second=""
third=""

for blog in "${all_blogs[@]}"; do
	blog=$(xargs <<< $blog)
	stat=$(yq '(.blogs[] | select(.file_name == "'"$blog"'")).publish_status' /scripts/article.yaml)
	readarray cat_order <<< $(yq '(.blogs[] | select(.file_name == "'"$blog"'")).cat_order[]' /scripts/article.yaml)
	read_count=$(yq '(.blogs[] | select(.file_name == "'"$blog"'")).read_count' /scripts/article.yaml)
	if [[ $stat == true ]]; then
		if [[ $read_count -ge $highest ]]; then
			third=$second
			second=$first
			author=$(yq '(.blogs[] | select(.file_name == "'"$blog"'")).author' /scripts/article.yaml)
			first=$(printf "%-20s | %-10s | %-10s | %-50s\n" "$(basename $blog)" "$author" "$read_count" "$blog")			
		fi
		for cat in ${cat_order[@]}; do
			cat_published[$(($cat-1))]=$((cat_published[$(($cat-1))]+1))
		done;
		total_published=$(($total_published+1))
	else
		for cat in ${cat_order[@]}; do
			cat_deleted[$(($cat-1))]=$((cat_deleted[$(($cat-1))]+1))	
		done;
		total_deleted=$(($total_deleted+1))
		echo done
	fi
done;

echo -e "\nSUMMARY"
printf "%-15s | %-15s\n" "-" "COUNT"
printf "%-15s | %-15s\n" "Total Published Articles:" "$total_published"
printf "%-15s | %-15s\n" "Total Deleted Articles:" "$total_deleted"
printf "%-15s | %-15s\n" "Total Articles:" "$(($total_published+$total_deleted))"

echo -e "\nSUMMARY BY TAGS"
echo -e "\n PUBLISHED BY TAGS"
printf "%-15s | %-15s\n" "TAGS" "COUNT"
printf "%-15s | %-15s\n" "SPORTS" "${cat_published[0]}"
printf "%-15s | %-15s\n" "CINEMA" "${cat_published[1]}"
printf "%-15s | %-15s\n" "TECHNOLOGY" "${cat_published[2]}"
printf "%-15s | %-15s\n" "TRAVEL" "${cat_published[3]}"
printf "%-15s | %-15s\n" "FOOD" "${cat_published[4]}"
printf "%-15s | %-15s\n" "LIFESTYLE" "${cat_published[5]}"
printf "%-15s | %-15s\n" "FINANCE" "${cat_published[6]}"

echo -e "\n DELETED BY TAGS"
printf "%-15s | %-15s\n" "TAGS" "COUNT"
printf "%-15s | %-15s\n" "SPORTS" "${cat_deleted[0]}"
printf "%-15s | %-15s\n" "CINEMA" "${cat_deleted[1]}"
printf "%-15s | %-15s\n" "TECHNOLOGY" "${cat_deleted[2]}"
printf "%-15s | %-15s\n" "TRAVEL" "${cat_deleted[3]}"
printf "%-15s | %-15s\n" "FOOD" "${cat_deleted[4]}"
printf "%-15s | %-15s\n" "LIFESTYLE" "${cat_deleted[5]}"
printf "%-15s | %-15s\n" "FINANCE" "${cat_deleted[6]}"

echo -e "\n TOP 3 MOST READ ARTICLES"
echo "RANK  | $(printf "%-20s | %-10s | %-10s | %-50s\n" "TITLE" "AUTHOR" "READ COUNT" "FILE PATH")"
echo "1     | $first"
echo "2     | $second"
echo "3     | $third"
